<!DOCTYPE html>
<html>
<head>
    <title>BTC Advanced Analytics</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { 
            background: #000; 
            color: #fff; 
            font-family: Arial, sans-serif; 
            margin: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .price { 
            font-size: 48px; 
            color: #00ff00; 
            margin: 10px 0;
        }
        .change {
            font-size: 24px;
            margin: 10px 0;
        }
        .positive { color: #00ff00; }
        .negative { color: #ff4444; }
        .chart-container {
            background: #111;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-title {
            text-align: center;
            font-size: 20px;
            margin-bottom: 20px;
            color: #00ff00;
        }
        canvas {
            min-height: 400px;
        }
        .signals-summary {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="price" id="price">Loading...</div>
            <div class="change" id="change"></div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Bitcoin Price with Buy/Sell Signals</div>
            <canvas id="priceChart"></canvas>
        </div>

        <div class="signals-summary" id="signalsSummary"></div>
    </div>

    <script>
        async function fetchPriceData() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=730');
                const data = await response.json();
                return data.map(d => ({
                    time: new Date(d[0]),
                    open: parseFloat(d[1]),
                    high: parseFloat(d[2]),
                    low: parseFloat(d[3]),
                    close: parseFloat(d[4]),
                    volume: parseFloat(d[5])
                }));
            } catch (error) {
                console.error('Error fetching price data:', error);
                return [];
            }
        }

        function calculateSMA(data, period) {
            return data.map((_, i, arr) => {
                if (i < period - 1) return null;
                const slice = arr.slice(i - period + 1, i + 1);
                return slice.reduce((sum, val) => sum + val, 0) / period;
            });
        }

        function generateBuySellSignals(shortSMA, longSMA, times, prices) {
            const signals = [];
            let buyPrice = null;

            for (let i = 1; i < shortSMA.length; i++) {
                if (shortSMA[i] > longSMA[i] && shortSMA[i - 1] <= longSMA[i - 1]) {
                    buyPrice = prices[i];
                    signals.push({ type: 'Buy', time: times[i], price: buyPrice });
                }
                if (shortSMA[i] < longSMA[i] && shortSMA[i - 1] >= longSMA[i - 1] && buyPrice !== null) {
                    const sellPrice = prices[i];
                    signals.push({ type: 'Sell', time: times[i], price: sellPrice });
                    buyPrice = null; // Reset for the next buy
                }
            }
            return signals;
        }

        function calculateProfitFromSignals(signals) {
            let profit = 0;
            let btcHeld = 0;
            let totalInvested = 1000; // Assume $1000 initial investment
            let initialBTC = totalInvested / signals[0].price;

            for (let i = 0; i < signals.length; i++) {
                if (signals[i].type === 'Buy') {
                    btcHeld = totalInvested / signals[i].price;
                    totalInvested = 0;
                } else if (signals[i].type === 'Sell') {
                    totalInvested = btcHeld * signals[i].price;
                    btcHeld = 0;
                    profit += totalInvested - 1000; // Calculate profit after the round-trip
                }
            }

            return { profit, btcHeld, totalInvested, initialBTC };
        }

        function createPriceChart(data, shortSMA, longSMA, signals) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            const times = data.map(d => d.time);
            const closePrices = data.map(d => d.close);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times,
                    datasets: [
                        {
                            label: 'BTC Price',
                            data: closePrices,
                            borderColor: '#00ff00',
                            tension: 0.1,
                        },
                        {
                            label: 'Short-Term SMA',
                            data: shortSMA,
                            borderColor: '#ffcc00',
                            tension: 0.1,
                            borderDash: [5, 5],
                        },
                        {
                            label: 'Long-Term SMA',
                            data: longSMA,
                            borderColor: '#ff4444',
                            tension: 0.1,
                            borderDash: [5, 5],
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                        },
                        y: {
                            title: { display: true, text: 'Price (USD)' }
                        }
                    }
                }
            });
        }

        async function updateDashboard() {
            const data = await fetchPriceData();
            if (data.length === 0) return;

            const times = data.map(d => d.time);
            const closePrices = data.map(d => d.close);

            const shortSMA = calculateSMA(closePrices, 20); // 20-day SMA
            const longSMA = calculateSMA(closePrices, 50); // 50-day SMA

            const signals = generateBuySellSignals(shortSMA, longSMA, times, closePrices);

            const { profit, btcHeld, totalInvested, initialBTC } = calculateProfitFromSignals(signals);
            const overallGain = ((closePrices[closePrices.length - 1] / closePrices[0]) - 1) * 100;
            const signalGain = ((totalInvested / 1000) - 1) * 100;

            document.getElementById('price').innerText = `BTC: $${closePrices[closePrices.length - 1].toFixed(2)}`;
            document.getElementById('change').innerText = `Overall BTC Gain: ${overallGain.toFixed(2)}% | Signal Gain: ${signalGain.toFixed(2)}%`;
            document.getElementById('change').className = signalGain > 0 ? 'positive' : 'negative';

            const signalsSummary = signals.map(
                (s, i) =>
                    `${s.type} at $${s.price.toFixed(2)} on ${s.time.toDateString()}${
                        s.type === 'Sell' && signals[i - 1]?.type === 'Buy'
                            ? ` | Gain: ${((s.price - signals[i - 1].price) / signals[i - 1].price * 100).toFixed(2)}%`
                            : ''
                    }`
            ).join('<br>');
            document.getElementById('signalsSummary').innerHTML = signalsSummary;

            createPriceChart(data, shortSMA, longSMA, signals);
        }

        updateDashboard();
        setInterval(updateDashboard, 60000);
    </script>
</body>
</html>
